<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÌÅ¥ÎûòÏä§ Î™¨Ïä§ÌÑ∞ ÌÇ§Ïö∞Í∏∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Baloo 2", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #ffe4f2, #e1f3ff, #fff8dd);
      color: #333;
    }
    .app-container {
      width: min(480px, 95vw);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      padding: 24px 20px 28px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
      text-align: center;
      border: 3px solid #ffd8f0;
      position: relative;
      overflow: hidden;
    }
    .app-container::before {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, #fff3c4 0, #ffdfeb 45%, transparent 70%);
      top: -80px;
      right: -60px;
      opacity: 0.7;
      z-index: -1;
    }
    .title-area { margin-bottom: 10px; }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: #fff4c3;
      color: #f28f3b;
      border: 1px dashed #f6b15c;
      margin-bottom: 4px;
    }
    h1 { font-size: 26px; margin-bottom: 4px; color: #444; }
    .class-name { font-size: 15px; color: #777; margin-bottom: 12px; }

    .monster-wrapper {
      margin: 10px auto 16px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #ffe6ff 35%, #ffe9c8 70%);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      border: 4px solid #ffe0ff;
      position: relative;
    }
    .monster-wrapper::after {
      content: "‚òÖ";
      position: absolute;
      font-size: 20px;
      top: 12px;
      right: 20px;
      color: #ffd54f;
      transform: rotate(-10deg);
    }
    .monster-wrapper::before {
      content: "‚ô•";
      position: absolute;
      font-size: 18px;
      bottom: 14px;
      left: 18px;
      color: #ff9aa2;
      transform: rotate(8deg);
    }
    .monster-image {
      width: 150px;
      height: 150px;
      object-fit: contain;
    }

    .level-label { font-size: 14px; margin-bottom: 2px; color: #666; }
    .cookie-info { font-size: 15px; margin-bottom: 8px; }
    .cookie-info span { font-weight: 700; color: #ff7b7b; }

    .progress-container {
      margin: 8px auto 4px;
      width: 100%;
      max-width: 360px;
      background: #ffeefb;
      border-radius: 999px;
      padding: 4px;
      border: 2px solid #ffcde6;
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.7);
    }
    .progress-bar {
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(90deg, #ffb6c1, #ffde7d, #a4e4ff);
      width: 0%;
      transition: width 0.4s ease-out;
    }
    .progress-text { font-size: 13px; margin-top: 4px; color: #555; }

    .status-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 12px;
      font-size: 13px;
      color: #666;
      flex-wrap: wrap;
    }
    .status-pill {
      background: #f1f5ff;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1ddff;
    }

    .error-message { margin-top: 6px; font-size: 12px; color: #e57373; }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: #999;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-updated { font-size: 11px; }

    .reload-button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: #ffd6e8;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
      box-shadow: 0 2px 0 rgba(230, 134, 173, 0.5);
    }
    .reload-button:hover { background: #ffc2df; }
    .reload-button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(230, 134, 173, 0.7);
    }

    .loading-dot {
      display: inline-block;
      font-size: 11px;
      color: #999;
    }

    @media (max-width: 480px) {
      .app-container { padding: 18px 16px 22px; }
      .monster-wrapper { width: 200px; height: 200px; }
      .monster-image { width: 135px; height: 135px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="title-area">
      <div class="badge">üç™ ÌÅ¥ÎûòÏä§ Î™¨Ïä§ÌÑ∞ ÌÇ§Ïö∞Í∏∞</div>
      <h1>Ïö∞Î¶¨ Î∞ò Î™¨Ïä§ÌÑ∞</h1>
      <div class="class-name" id="classNameLabel">ÎÇ¥ Î∞ò Ïù¥Î¶Ñ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>

    <div class="monster-wrapper">
      <img
        src="images/egg.png"
        alt="Í∑ÄÏó¨Ïö¥ Î™¨Ïä§ÌÑ∞"
        class="monster-image"
        id="monsterImage"
      />
    </div>

    <div class="level-label" id="levelLabel">Î†àÎ≤® Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>

    <div class="cookie-info" id="cookieInfo">
      ÌòÑÏû¨ Ïø†ÌÇ§: <span>0Í∞ú</span>, Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ <span>0Í∞ú</span>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0% Îã¨ÏÑ±</div>

    <div class="status-row">
      <div class="status-pill" id="rangeLabel">0 ~ 99Í∞ú Íµ¨Í∞Ñ</div>
      <div class="status-pill" id="statusPill">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>

    <div class="error-message" id="errorMessage" style="display:none;"></div>

    <div class="footer">
      <span class="last-updated" id="lastUpdated">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: -</span>
      <span>
        <button class="reload-button" id="reloadButton">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
        <span class="loading-dot" id="loadingDot" style="display:none;">(Î∂àÎü¨Ïò§Îäî Ï§ë)</span>
      </span>
    </div>
  </div>

  <script>
    // ==========================
    // 1. Í∏∞Î≥∏ ÏÑ§Ï†ï
    // ==========================
    const API_KEY  = 'ad7855503128e6188fd23f133296506a69f9857cdc3d6a1a';   // Íº≠ Î∞îÍæ∏Í∏∞!
    const API_URL  = 'https://api.dahandin.com/openapi/v1/get/class/list';
    const CLASS_NAME = '3ÌïôÎÖÑ 1Î∞ò';               // Îã§ÌñàÎãàÏóê Îì±Î°ùÎêú Î∞ò Ïù¥Î¶ÑÍ≥º ÏôÑÏ†ÑÌûà ÎèôÏùºÌïòÍ≤å
    const REFRESH_INTERVAL_MS = 10000;

    // ==========================
    // 2. DOM ÏöîÏÜå
    // ==========================
    const monsterImageEl   = document.getElementById('monsterImage');
    const classNameLabelEl = document.getElementById('classNameLabel');
    const levelLabelEl     = document.getElementById('levelLabel');
    const cookieInfoEl     = document.getElementById('cookieInfo');
    const progressBarEl    = document.getElementById('progressBar');
    const progressTextEl   = document.getElementById('progressText');
    const rangeLabelEl     = document.getElementById('rangeLabel');
    const statusPillEl     = document.getElementById('statusPill');
    const errorMessageEl   = document.getElementById('errorMessage');
    const lastUpdatedEl    = document.getElementById('lastUpdated');
    const reloadButtonEl   = document.getElementById('reloadButton');
    const loadingDotEl     = document.getElementById('loadingDot');

    // ==========================
    // 3. Ïú†Ìã∏ Ìï®Ïàò
    // ==========================
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    function formatLastUpdated(date) {
      const pad = (n) => (n < 10 ? '0' + n : n);
      const y = date.getFullYear();
      const m = pad(date.getMonth() + 1);
      const d = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      const ss = pad(date.getSeconds());
      return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    // Ïø†ÌÇ§ Ïàò ‚Üí Ïù¥ÎØ∏ÏßÄ/Î†àÎ≤®/Íµ¨Í∞Ñ Í≤∞Ï†ï
    function getMonsterState(totalCookies) {
      let imagePath       = 'images/egg.png';
      let levelText       = 'Ïïå(egg) Îã®Í≥Ñ';
      let rangeText       = '0 ~ 99Í∞ú Íµ¨Í∞Ñ';
      let minForThisLevel = 0;
      let nextLevelAt     = 100;

      if (totalCookies >= 600) {
        imagePath       = 'images/level3.png';
        levelText       = 'Î†àÎ≤® 3';
        rangeText       = '600 ~ 999Í∞ú Íµ¨Í∞Ñ';
        minForThisLevel = 600;
        nextLevelAt     = null;   // ÏµúÍ≥† Î†àÎ≤®
      } else if (totalCookies >= 300) {
        imagePath       = 'images/level2.png';
        levelText       = 'Î†àÎ≤® 2';
        rangeText       = '300 ~ 599Í∞ú Íµ¨Í∞Ñ';
        minForThisLevel = 300;
        nextLevelAt     = 600;
      } else if (totalCookies >= 100) {
        imagePath       = 'images/level1.png';
        levelText       = 'Î†àÎ≤® 1';
        rangeText       = '100 ~ 299Í∞ú Íµ¨Í∞Ñ';
        minForThisLevel = 100;
        nextLevelAt     = 300;
      } else {
        imagePath       = 'images/egg.png';
        levelText       = 'Ïïå(egg) Îã®Í≥Ñ';
        rangeText       = '0 ~ 99Í∞ú Íµ¨Í∞Ñ';
        minForThisLevel = 0;
        nextLevelAt     = 100;
      }

      return { imagePath, levelText, rangeText, minForThisLevel, nextLevelAt };
    }

    function calculateProgressPercent(totalCookies, minForThisLevel, nextLevelAt) {
      if (nextLevelAt === null) return 100;  // ÏµúÍ≥† Î†àÎ≤®
      const range = nextLevelAt - minForThisLevel;
      if (range <= 0) return 0;
      const valueInRange = totalCookies - minForThisLevel;
      const ratio = Math.max(0, Math.min(1, valueInRange / range));
      return Math.round(ratio * 100);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        loadingDotEl.style.display = 'inline';
        reloadButtonEl.disabled    = true;
        reloadButtonEl.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë...';
      } else {
        loadingDotEl.style.display = 'none';
        reloadButtonEl.disabled    = false;
        reloadButtonEl.textContent = 'üîÑ ÏÉàÎ°úÍ≥†Ïπ®';
      }
    }

    function showError(message) {
      errorMessageEl.style.display = 'block';
      errorMessageEl.textContent   = message;
      statusPillEl.textContent     = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥Ïöî üò¢';
    }

    // ==========================
    // 4. UI Í∞±Ïã† ÌïµÏã¨ Ìï®Ïàò
    // ==========================
    function updateUIWithClassData(classData) {
      const name = classData?.name || 'ÌïôÍ∏â Ïù¥Î¶Ñ ÏóÜÏùå';

      // ‚òÖ totalCookiesÎäî API ÏùëÎãµÏóê Ïù¥ÎØ∏ ÏûàÏùå
      const rawTotal = classData?.totalCookies;
      const totalCookies =
        typeof rawTotal === 'number' && !isNaN(rawTotal) ? rawTotal : 0;

      const state   = getMonsterState(totalCookies);
      const percent = calculateProgressPercent(
        totalCookies,
        state.minForThisLevel,
        state.nextLevelAt
      );

      // Ïù¥ÎØ∏ÏßÄ
      monsterImageEl.src = state.imagePath;

      // ÌïôÍ∏â Ïù¥Î¶Ñ
      classNameLabelEl.textContent = name;

      // Î†àÎ≤®
      levelLabelEl.textContent = state.levelText;

      // Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ
      let remainingText;
      if (state.nextLevelAt === null) {
        remainingText = 'Ïù¥ÎØ∏ ÏµúÍ≥† Î†àÎ≤®Ïù¥ÏóêÏöî! üéâ';
      } else {
        const remain = Math.max(0, state.nextLevelAt - totalCookies);
        remainingText = `Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ ${formatNumber(remain)}Í∞ú`;
      }

      cookieInfoEl.innerHTML =
        `ÌòÑÏû¨ Ïø†ÌÇ§: <span>${formatNumber(totalCookies)}Í∞ú</span>, ` +
        remainingText;

      // ÏßÑÌñâ Î∞î
      progressBarEl.style.width = `${percent}%`;
      progressTextEl.textContent = `${percent}% Îã¨ÏÑ±`;

      // Íµ¨Í∞Ñ ÎùºÎ≤®
      rangeLabelEl.textContent = state.rangeText;

      // ÏÉÅÌÉú Ìïú Ï§Ñ
      if (totalCookies === 0) {
        statusPillEl.textContent = 'ÏãúÏûë Îã®Í≥Ñ, Ïø†ÌÇ§ Î™®ÏúºÍ∏∞ Ï∂úÎ∞ú! üê£';
      } else if (state.nextLevelAt === null) {
        statusPillEl.textContent = 'ÏµúÍ≥† Î†àÎ≤® Îã¨ÏÑ±! Í≥ÑÏÜç Ïø†ÌÇ§Î•º Î™®ÏïÑÎ¥êÏöî ‚ú®';
      } else {
        statusPillEl.textContent = 'Ïö∞Î¶¨ Î∞òÏù¥ Ïø†ÌÇ§Î•º Ïó¥Ïã¨Ìûà Î™®ÏúºÎäî Ï§ëÏù¥ÏóêÏöî üí™';
      }

      // ÏóêÎü¨ Ïà®Í∏∞Í∏∞
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent   = '';

      // ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Ñ
      lastUpdatedEl.textContent =
        `ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${formatLastUpdated(new Date())}`;
    }

    // ==========================
    // 5. API Ìò∏Ï∂ú
    // ==========================
    async function fetchClassData() {
      try {
        setLoading(true);

        const response = await fetch(API_URL, {
          method: 'GET',
          headers: {
            'X-API-Key': API_KEY
          }
        });

        if (!response.ok) {
          // 401, 403, 429, 500 Îì±
          throw new Error(`API ÏùëÎãµ Ïò§Î•ò (HTTP ${response.status})`);
        }

        const json = await response.json();
        console.log('Ï†ÑÏ≤¥ ÏùëÎãµ:', json); // ÎîîÎ≤ÑÍπÖÏö©

        if (json.result !== true) {
          // API KEY Ïò§Î•ò Îì±
          throw new Error(json.message || 'APIÏóêÏÑú Ïò§Î•òÎ•º Î∞òÌôòÌñàÏäµÎãàÎã§.');
        }

        const list = Array.isArray(json.data) ? json.data : [];
        console.log('ÌÅ¥ÎûòÏä§ Î¶¨Ïä§Ìä∏:', list); // ÎîîÎ≤ÑÍπÖÏö©

        if (!list.length) {
          throw new Error('API ÏùëÎãµÏóê ÌïôÍ∏â Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }

        // ÎÇ¥ Î∞ò Ï∞æÍ∏∞
        let classData = list.find((item) => item.name === CLASS_NAME);
        console.log('Ï∞æÏùÄ ÌÅ¥ÎûòÏä§ Îç∞Ïù¥ÌÑ∞:', classData); // ÎîîÎ≤ÑÍπÖÏö©

        if (!classData) {
          // Ïù¥Î¶ÑÏù¥ Ïïà ÎßûÏúºÎ©¥ Ï≤´ Î≤àÏß∏ Î∞òÏúºÎ°úÎùºÎèÑ ÌëúÏãú
          classData = list[0];
        }

        updateUIWithClassData(classData);
      } catch (err) {
        console.error('ÏóêÎü¨ ÏÉÅÏÑ∏:', err);
        showError(err.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      } finally {
        setLoading(false);
      }
    }

    // ==========================
    // 6. Ï¥àÍ∏∞Ìôî
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      fetchClassData();
      reloadButtonEl.addEventListener('click', fetchClassData);
      setInterval(fetchClassData, REFRESH_INTERVAL_MS);
    });
  </script>
</body>
</html>
