<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í´ë˜ìŠ¤ ëª¬ìŠ¤í„° í‚¤ìš°ê¸°</title>
  
  <!-- ê·€ì—¬ìš´ í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- ëª¨ë°”ì¼ ë””ë²„ê¹… ë„êµ¬ (ê°œë°œ ì™„ë£Œ í›„ ì‚­ì œ ê°€ëŠ¥) -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Baloo 2", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #ffe4f2, #e1f3ff, #fff8dd);
      color: #333;
    }

    .app-container {
      width: min(480px, 95vw);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      padding: 24px 20px 28px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
      text-align: center;
      border: 3px solid #ffd8f0;
      position: relative;
      overflow: hidden;
    }

    .app-container::before {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, #fff3c4 0, #ffdfeb 45%, transparent 70%);
      top: -80px;
      right: -60px;
      opacity: 0.7;
      z-index: -1;
    }

    .title-area {
      margin-bottom: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: #fff4c3;
      color: #f28f3b;
      border: 1px dashed #f6b15c;
      margin-bottom: 4px;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 4px;
      color: #444;
    }

    .class-name {
      font-size: 15px;
      color: #777;
      margin-bottom: 12px;
    }

    .monster-wrapper {
      margin: 10px auto 16px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #ffe6ff 35%, #ffe9c8 70%);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      border: 4px solid #ffe0ff;
      position: relative;
    }

    .monster-wrapper::after {
      content: "â˜…";
      position: absolute;
      font-size: 20px;
      top: 12px;
      right: 20px;
      color: #ffd54f;
      transform: rotate(-10deg);
    }

    .monster-wrapper::before {
      content: "â™¥";
      position: absolute;
      font-size: 18px;
      bottom: 14px;
      left: 18px;
      color: #ff9aa2;
      transform: rotate(8deg);
    }

    .monster-image {
      width: 150px;
      height: 150px;
      object-fit: contain;
    }

    .level-label {
      font-size: 14px;
      margin-bottom: 2px;
      color: #666;
    }

    .cookie-info {
      font-size: 15px;
      margin-bottom: 8px;
    }

    .cookie-info span {
      font-weight: 700;
      color: #ff7b7b;
    }

    .progress-container {
      margin: 8px auto 4px;
      width: 100%;
      max-width: 360px;
      background: #ffeefb;
      border-radius: 999px;
      padding: 4px;
      border: 2px solid #ffcde6;
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.7);
    }

    .progress-bar {
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(90deg, #ffb6c1, #ffde7d, #a4e4ff);
      width: 0%;
      transition: width 0.4s ease-out;
    }

    .progress-text {
      font-size: 13px;
      margin-top: 4px;
      color: #555;
    }

    .status-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 12px;
      font-size: 13px;
      color: #666;
      flex-wrap: wrap;
    }

    .status-pill {
      background: #f1f5ff;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1ddff;
    }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: #999;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .last-updated {
      font-size: 11px;
    }

    .error-message {
      margin-top: 6px;
      font-size: 12px;
      color: #e57373;
    }

    .reload-button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: #ffd6e8;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
      box-shadow: 0 2px 0 rgba(230, 134, 173, 0.5);
    }

    .reload-button:hover {
      background: #ffc2df;
    }

    .reload-button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(230, 134, 173, 0.7);
    }

    .loading-dot {
      display: inline-block;
      font-size: 11px;
      color: #999;
    }

    @media (max-width: 480px) {
      .app-container {
        padding: 18px 16px 22px;
      }

      .monster-wrapper {
        width: 200px;
        height: 200px;
      }

      .monster-image {
        width: 135px;
        height: 135px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="title-area">
      <div class="badge">ğŸª í´ë˜ìŠ¤ ëª¬ìŠ¤í„° í‚¤ìš°ê¸°</div>
      <h1>ìš°ë¦¬ ë°˜ ëª¬ìŠ¤í„°</h1>
      <div class="class-name" id="classNameLabel">ë‚´ ë°˜ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="monster-wrapper">
      <img
        src="images/egg.png"
        alt="ê·€ì—¬ìš´ ëª¬ìŠ¤í„°"
        class="monster-image"
        id="monsterImage"
      />
    </div>

    <div class="level-label" id="levelLabel">ë ˆë²¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div class="cookie-info" id="cookieInfo">
      í˜„ì¬ ì¿ í‚¤: <span>0ê°œ</span>, ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ <span>0ê°œ</span>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0% ë‹¬ì„±</div>

    <div class="status-row">
      <div class="status-pill" id="rangeLabel">0 ~ 99ê°œ êµ¬ê°„</div>
      <div class="status-pill" id="statusPill">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="error-message" id="errorMessage" style="display:none;"></div>

    <div class="footer">
      <span class="last-updated" id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
      <span>
        <button class="reload-button" id="reloadButton">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <span class="loading-dot" id="loadingDot" style="display:none;">(ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘)</span>
      </span>
    </div>
  </div>

  <script>
    // ==========================
    // 1. ê¸°ë³¸ ì„¤ì •
    // ==========================
    const API_KEY  = 'ad7855503128e6188fd23f133296506a69f9857cdc3d6a1a';   // â­ ë³¸ì¸ API KEYë¡œ ë³€ê²½!
    const API_URL  = 'https://api.dahandin.com/openapi/v1/get/class/list';
    const CLASS_NAME = 'ë”°ëœ»í•œì¸ì„±';               // â­ ë‹¤í–ˆë‹ˆì— ë“±ë¡ëœ ë°˜ ì´ë¦„ê³¼ ì™„ì „íˆ ë™ì¼í•˜ê²Œ
    const REFRESH_INTERVAL_MS = 10000;             // 10ì´ˆ

    console.log('ğŸ¯ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨!');
    console.log('ğŸ“š ì„¤ì •ëœ CLASS_NAME:', CLASS_NAME);

    // ==========================
    // 2. DOM ìš”ì†Œ
    // ==========================
    const monsterImageEl   = document.getElementById('monsterImage');
    const classNameLabelEl = document.getElementById('classNameLabel');
    const levelLabelEl     = document.getElementById('levelLabel');
    const cookieInfoEl     = document.getElementById('cookieInfo');
    const progressBarEl    = document.getElementById('progressBar');
    const progressTextEl   = document.getElementById('progressText');
    const rangeLabelEl     = document.getElementById('rangeLabel');
    const statusPillEl     = document.getElementById('statusPill');
    const errorMessageEl   = document.getElementById('errorMessage');
    const lastUpdatedEl    = document.getElementById('lastUpdated');
    const reloadButtonEl   = document.getElementById('reloadButton');
    const loadingDotEl     = document.getElementById('loadingDot');

    // ==========================
    // 3. ìœ í‹¸ í•¨ìˆ˜
    // ==========================
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    function formatLastUpdated(date) {
      const pad = (n) => (n < 10 ? '0' + n : n);
      const y = date.getFullYear();
      const m = pad(date.getMonth() + 1);
      const d = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      const ss = pad(date.getSeconds());
      return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    // ì¿ í‚¤ ìˆ˜ â†’ ì´ë¯¸ì§€/ë ˆë²¨/êµ¬ê°„ ê²°ì •
    function getMonsterState(totalCookies) {
      let imagePath       = 'images/egg.png';
      let levelText       = 'ì•Œ(egg) ë‹¨ê³„';
      let rangeText       = '0 ~ 99ê°œ êµ¬ê°„';
      let minForThisLevel = 0;
      let nextLevelAt     = 100;

      if (totalCookies >= 600) {
        imagePath       = 'images/level3.png';
        levelText       = 'ë ˆë²¨ 3';
        rangeText       = '600ê°œ ì´ìƒ';
        minForThisLevel = 600;
        nextLevelAt     = null;   // ìµœê³  ë ˆë²¨
      } else if (totalCookies >= 300) {
        imagePath       = 'images/level2.png';
        levelText       = 'ë ˆë²¨ 2';
        rangeText       = '300 ~ 599ê°œ êµ¬ê°„';
        minForThisLevel = 300;
        nextLevelAt     = 600;
      } else if (totalCookies >= 100) {
        imagePath       = 'images/level1.png';
        levelText       = 'ë ˆë²¨ 1';
        rangeText       = '100 ~ 299ê°œ êµ¬ê°„';
        minForThisLevel = 100;
        nextLevelAt     = 300;
      } else {
        imagePath       = 'images/egg.png';
        levelText       = 'ì•Œ(egg) ë‹¨ê³„';
        rangeText       = '0 ~ 99ê°œ êµ¬ê°„';
        minForThisLevel = 0;
        nextLevelAt     = 100;
      }

      return { imagePath, levelText, rangeText, minForThisLevel, nextLevelAt };
    }

    function calculateProgressPercent(totalCookies, minForThisLevel, nextLevelAt) {
      if (nextLevelAt === null) return 100;  // ìµœê³  ë ˆë²¨
      const range = nextLevelAt - minForThisLevel;
      if (range <= 0) return 0;
      const valueInRange = totalCookies - minForThisLevel;
      const ratio = Math.max(0, Math.min(1, valueInRange / range));
      return Math.round(ratio * 100);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        loadingDotEl.style.display = 'inline';
        reloadButtonEl.disabled    = true;
        reloadButtonEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      } else {
        loadingDotEl.style.display = 'none';
        reloadButtonEl.disabled    = false;
        reloadButtonEl.textContent = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
      }
    }

    function showError(message) {
      errorMessageEl.style.display = 'block';
      errorMessageEl.textContent   = message;
      statusPillEl.textContent     = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìˆì–´ìš” ğŸ˜¢';
    }

    // ==========================
    // 4. UI ê°±ì‹  í•µì‹¬ í•¨ìˆ˜ (ìˆ˜ì •ë¨!)
    // ==========================
    function updateUIWithClassData(classData) {
      const name = classData?.name || 'í•™ê¸‰ ì´ë¦„ ì—†ìŒ';

      // â­ ìˆ˜ì •: totalCookiesê°€ nullì´ë©´ cookies ê°’ ì‚¬ìš©
      let totalCookies = classData?.totalCookies;
      
      // totalCookiesê°€ nullì´ê±°ë‚˜ ì—†ìœ¼ë©´ cookies ê°’ìœ¼ë¡œ ëŒ€ì²´
      if (totalCookies === null || totalCookies === undefined || isNaN(totalCookies)) {
        totalCookies = classData?.cookies || 0;
      }
      
      // ìˆ«ìë¡œ ë³€í™˜
      totalCookies = Number(totalCookies);

      console.log('âœ… ìµœì¢… ì‚¬ìš©í•  ì¿ í‚¤ ê°œìˆ˜:', totalCookies);

      const state   = getMonsterState(totalCookies);
      const percent = calculateProgressPercent(
        totalCookies,
        state.minForThisLevel,
        state.nextLevelAt
      );

      // ì´ë¯¸ì§€
      monsterImageEl.src = state.imagePath;

      // í•™ê¸‰ ì´ë¦„
      classNameLabelEl.textContent = name;

      // ë ˆë²¨
      levelLabelEl.textContent = state.levelText;

      // ë‹¤ìŒ ë ˆë²¨ê¹Œì§€
      let remainingText;
      if (state.nextLevelAt === null) {
        remainingText = 'ì´ë¯¸ ìµœê³  ë ˆë²¨ì´ì—ìš”! ğŸ‰';
      } else {
        const remain = Math.max(0, state.nextLevelAt - totalCookies);
        remainingText = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${formatNumber(remain)}ê°œ`;
      }

      cookieInfoEl.innerHTML =
        `í˜„ì¬ ì¿ í‚¤: <span>${formatNumber(totalCookies)}ê°œ</span>, ` +
        remainingText;

      // ì§„í–‰ ë°”
      progressBarEl.style.width = `${percent}%`;
      progressTextEl.textContent = `${percent}% ë‹¬ì„±`;

      // êµ¬ê°„ ë¼ë²¨
      rangeLabelEl.textContent = state.rangeText;

      // ìƒíƒœ í•œ ì¤„
      if (totalCookies === 0) {
        statusPillEl.textContent = 'ì‹œì‘ ë‹¨ê³„, ì¿ í‚¤ ëª¨ìœ¼ê¸° ì¶œë°œ! ğŸ£';
      } else if (state.nextLevelAt === null) {
        statusPillEl.textContent = 'ìµœê³  ë ˆë²¨ ë‹¬ì„±! ê³„ì† ì¿ í‚¤ë¥¼ ëª¨ì•„ë´ìš” âœ¨';
      } else {
        statusPillEl.textContent = 'ìš°ë¦¬ ë°˜ì´ ì¿ í‚¤ë¥¼ ì—´ì‹¬íˆ ëª¨ìœ¼ëŠ” ì¤‘ì´ì—ìš” ğŸ’ª';
      }

      // ì—ëŸ¬ ìˆ¨ê¸°ê¸°
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent   = '';

      // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
      lastUpdatedEl.textContent =
        `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${formatLastUpdated(new Date())}`;
    }

    // ==========================
    // 5. API í˜¸ì¶œ
    // ==========================
    async function fetchClassData() {
      try {
        setLoading(true);

        console.log('ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ API_KEY:', API_KEY);
        console.log('ğŸ“š ì°¾ìœ¼ë ¤ëŠ” CLASS_NAME:', CLASS_NAME);

        const response = await fetch(API_URL, {
          method: 'GET',
          headers: {
            'X-API-Key': API_KEY
          }
        });

        console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);

        if (!response.ok) {
          throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜ (HTTP ${response.status})`);
        }

        const json = await response.json();
        console.log('ğŸ“¦ ì „ì²´ ì‘ë‹µ:', json);

        if (json.result !== true) {
          console.error('âŒ API ì—ëŸ¬:', json.message);
          throw new Error(json.message || 'APIì—ì„œ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.');
        }

        const list = Array.isArray(json.data) ? json.data : [];
        console.log('ğŸ“‹ í´ë˜ìŠ¤ ë¦¬ìŠ¤íŠ¸:', list);

        if (!list.length) {
          throw new Error('API ì‘ë‹µì— í•™ê¸‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ëª¨ë“  í´ë˜ìŠ¤ ì´ë¦„ ì¶œë ¥
        console.log('ğŸ“ ë“±ë¡ëœ í´ë˜ìŠ¤ ì´ë¦„ë“¤:');
        list.forEach((item, index) => {
          console.log(`  ${index + 1}. "${item.name}" - totalCookies: ${item.totalCookies}, cookies: ${item.cookies}`);
        });

        // ë‚´ ë°˜ ì°¾ê¸°
        let classData = list.find((item) => item.name === CLASS_NAME);
        console.log('ğŸ¯ ì°¾ì€ í´ë˜ìŠ¤ ë°ì´í„°:', classData);

        if (!classData) {
          console.warn('âš ï¸ í´ë˜ìŠ¤ ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì²« ë²ˆì§¸ ë°˜ ì‚¬ìš©');
          classData = list[0];
        }

        updateUIWithClassData(classData);
      } catch (err) {
        console.error('ğŸ’¥ ì—ëŸ¬ ë°œìƒ:', err);
        showError(err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setLoading(false);
      }
    }

    // ==========================
    // 6. ì´ˆê¸°í™”
    // ==========================
    function initApp() {
      console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘!');
      fetchClassData();
      reloadButtonEl.addEventListener('click', fetchClassData);
      setInterval(fetchClassData, REFRESH_INTERVAL_MS);
    }

    // DOM ì¤€ë¹„ ì—¬ë¶€ ì²´í¬
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
